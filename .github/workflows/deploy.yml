name: Deploy Power BI to Fabric

on:
  push:
    branches:
      - dev
      - prp
      - prd
    paths:
      - 'src/**'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment à déployer'
        required: true
        type: choice
        options:
          - dev
          - prp
          - prd

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.12'
      
      - name: Install dependencies
        run: |
          pip install requests
      
      - name: Determine environment
        id: env
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "environment=${{ inputs.environment }}" >> $GITHUB_OUTPUT
          else
            # Extraire l'environnement depuis le nom de la branche
            BRANCH=${{ github.ref_name }}
            echo "environment=$BRANCH" >> $GITHUB_OUTPUT
          fi
      
      - name: Deploy to Fabric
        env:
          FABRIC_TENANT_ID: ${{ secrets.SPN_TENANT_ID }}
          FABRIC_CLIENT_ID: ${{ secrets.SPN_CLIENT_ID }}
          FABRIC_CLIENT_SECRET: ${{ secrets.SPN_CLIENT_SECRET }}
          FABRIC_ENV: ${{ steps.env.outputs.environment }}
        run: |
          echo "=== Déploiement vers $FABRIC_ENV ==="
          python scripts/deploy.py --env $FABRIC_ENV